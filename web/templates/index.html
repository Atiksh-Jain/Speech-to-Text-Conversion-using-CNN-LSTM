<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speech to Text using CNN–LSTM in noisy environments</title>
    <style>
        :root {
            --bg: #f5f5f7;
            --bg-elevated: #ffffff;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.08);
            --accent-alt: #22c55e;
            --border-subtle: rgba(148, 163, 184, 0.3);
            --text-main: #111827;
            --text-soft: #6b7280;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text-main);
        }
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(18px);
            background: rgba(255, 255, 255, 0.92);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0.9rem 2.25rem;
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .title-group h1 {
            margin: 0;
            font-size: 1.4rem;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .title-pill {
            font-size: 0.75rem;
            padding: 0.15rem 0.6rem;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .title-group p {
            margin: 0.15rem 0 0;
            font-size: 0.8rem;
            color: var(--text-soft);
        }
        .header-badges {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
        }
        .badge {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: rgba(15, 23, 42, 0.8);
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }
        .badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
        }
        main {
            padding: 1.75rem 2rem 3rem;
            max-width: 960px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h2 {
            margin-top: 0;
            font-size: 1.1rem;
        }
        .card {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 1rem 1.3rem 1.3rem;
            margin-bottom: 1.2rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
        }
        .card-header-line {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-soft);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.7rem;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        button {
            padding: 0.55rem 1.2rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: background 0.18s ease, transform 0.1s ease, box-shadow 0.18s ease;
        }
        button:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
            transform: none;
        }
        #startBtn {
            background: linear-gradient(135deg, var(--accent), #4f46e5);
            color: white;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.45);
        }
        #startBtn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(79, 70, 229, 0.6);
        }
        #stopBtn {
            background: linear-gradient(135deg, #f97373, #ef4444);
            color: white;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.45);
        }
        #stopBtn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(239, 68, 68, 0.6);
        }
        #status {
            font-size: 0.85rem;
            color: var(--text-soft);
        }
        .engine-toggle-label {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            color: var(--text-soft);
            padding: 0.25rem 0.55rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        .engine-toggle-label input {
            accent-color: var(--accent);
        }
        #transcription {
            font-size: 0.98rem;
            padding: 0.65rem 0.75rem;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 10px;
            min-height: 2.2rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.85);
            white-space: pre-wrap;
        }
        .two-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .plots-grid, .diagrams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
        }
        .carousel-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .carousel-window {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 360px;
            overflow: hidden;
            border-radius: 12px;
            background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
            box-shadow: inset 0 0 0 1px rgba(30, 64, 175, 0.35), 0 18px 45px rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-btn {
            background: radial-gradient(circle at top left, #1d4ed8, #0f172a);
            color: #e5e7eb;
            border-radius: 999px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
        }
        .carousel-btn:disabled {
            opacity: 0.35;
            cursor: default;
            box-shadow: none;
        }
        .plot-slide, .diagram-slide {
            position: absolute;
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            opacity: 0;
            transform: translateX(40px) scale(0.98);
            transition: opacity 0.35s ease, transform 0.35s ease;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
        }
        .plot-slide.active, .diagram-slide.active {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
        .plot-caption, .diagram-caption {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-bottom: 0.75rem;
        }
        .img-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }
        .img-card img {
            width: 100%;
            border-radius: 6px;
        }
        .img-card span {
            display: block;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            color: var(--text-soft);
        }
        .mic-visual-wrapper {
            margin-top: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .mic-indicator {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #4f46e5, #0f172a);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.0);
            border: 1px solid rgba(129, 140, 248, 0.7);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .mic-indicator svg {
            width: 18px;
            height: 18px;
            fill: #e5e7eb;
        }
        .mic-indicator.recording {
            animation: micPulse 1.4s ease-out infinite;
            transform: translateY(-1px);
        }
        @keyframes micPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.7);
            }
            70% {
                box-shadow: 0 0 0 12px rgba(129, 140, 248, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(129, 140, 248, 0);
            }
        }
    </style>
</head>
<body>
<header>
    <h1>Speech to Text using CNN–LSTM in noisy environments</h1>
    <p>VTU Final Year Project – Live CPU-only ASR Demo</p>
</header>
<main>
    <section class="card">
        <h2>Live Microphone Recognition</h2>
        <div style="background: #fff3cd; padding: 0.8rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;">
            <strong>⚠️ Troubleshooting:</strong> If you see "Error accessing microphone":
            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                <li>Click the lock/camera icon in your browser's address bar and allow microphone access</li>
                <li>Use Chrome, Firefox, or Edge (Safari may have issues)</li>
                <li>Make sure a microphone is connected and not used by another app</li>
                <li>If on localhost, some browsers require HTTPS - try: <code>http://127.0.0.1:5000</code> instead</li>
            </ul>
        </div>
        <div class="controls">
            <button id="startBtn">Start Recording</button>
            <button id="stopBtn" disabled>Stop</button>
            <span id="status">Idle</span>
        </div>
        <div class="mic-visual-wrapper">
            <div class="mic-indicator" id="micIndicator">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3zm5-3a1 1 0 1 1 2 0 7 7 0 0 1-6 6.93V20h2a1 1 0 1 1 0 2h-6a1 1 0 1 1 0-2h2v-2.07A7 7 0 0 1 5 11a1 1 0 1 1 2 0 5 5 0 0 0 10 0z"/>
                </svg>
            </div>
            <span style="font-size:0.8rem; color:var(--text-soft);">Live mic level reacts while recording.</span>
        </div>
        <div>
            <strong>Transcription:</strong>
            <div id="transcription"></div>
        </div>
        <div style="margin-top: 1rem;">
            <strong>Recent Recognitions:</strong>
            <div style="margin-top:0.4rem; overflow-x:auto;">
                <table id="historyTable" style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                    <thead>
                        <tr style="background: rgba(15,23,42,0.95);">
                            <th style="padding:0.35rem 0.5rem; text-align:left; border-bottom:1px solid rgba(148,163,184,0.35);">#</th>
                            <th style="padding:0.35rem 0.5rem; text-align:left; border-bottom:1px solid rgba(148,163,184,0.35);">Text</th>
                            <th style="padding:0.35rem 0.5rem; text-align:left; border-bottom:1px solid rgba(148,163,184,0.35);">Noise (dB)</th>
                            <th style="padding:0.35rem 0.5rem; text-align:left; border-bottom:1px solid rgba(148,163,184,0.35);">Confidence</th>
                            <th style="padding:0.35rem 0.5rem; text-align:left; border-bottom:1px solid rgba(148,163,184,0.35);">Duration (s)</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="card">
        <h2>Training & Evaluation Plots</h2>
        {% if plots %}
        <div class="plot-caption" id="plotCaption"></div>
        <div class="carousel-container">
            <button class="carousel-btn" id="prevPlotBtn">&#8249;</button>
            <div class="carousel-window" id="plotCarousel">
                {% for p in plots %}
                <img src="{{ url_for('static', filename=p) }}" alt="{{ p }}" class="plot-slide{% if loop.first %} active{% endif %}" data-caption="{{ p }}">
                {% endfor %}
            </div>
            <button class="carousel-btn" id="nextPlotBtn">&#8250;</button>
        </div>
        {% else %}
        <p>No plots yet. Run <code>python -m src.plots</code> after training.</p>
        {% endif %}
    </section>

    <section class="card">
        <h2>System & Architecture Diagrams</h2>
        {% if diagrams %}
        <div class="diagram-caption" id="diagramCaption"></div>
        <div class="carousel-container">
            <button class="carousel-btn" id="prevDiagramBtn">&#8249;</button>
            <div class="carousel-window" id="diagramCarousel">
                {% for d in diagrams %}
                <img src="{{ url_for('static', filename=d) }}" alt="{{ d }}" class="diagram-slide{% if loop.first %} active{% endif %}" data-caption="{{ d }}">
                {% endfor %}
            </div>
            <button class="carousel-btn" id="nextDiagramBtn">&#8250;</button>
        </div>
        {% else %}
        <p>No diagrams yet. Run <code>python -m src.plots --diagrams_only</code> to generate them.</p>
        {% endif %}
    </section>
</main>

<script>
    let mediaRecorder = null;
    let audioChunks = [];

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const transcriptionEl = document.getElementById('transcription');
    const historyBody = document.getElementById('historyBody');
    const micIndicator = document.getElementById('micIndicator');
    let historyIndex = 1;

    async function startRecording() {
        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusEl.textContent = 'Error: Microphone API not supported. Use Chrome, Firefox, or Edge.';
                return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    channelCount: 1,
                    sampleRate: 16000,
                    echoCancellation: true,
                    noiseSuppression: true
                } 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/webm;codecs=opus'
            });
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = async () => {
                stream.getTracks().forEach(track => track.stop());
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                await sendAudio(blob);
            };

            mediaRecorder.start();
            statusEl.textContent = 'Recording...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            transcriptionEl.textContent = '';
            if (micIndicator) {
                micIndicator.classList.add('recording');
            }
        } catch (err) {
            console.error('Microphone error:', err);
            let errorMsg = 'Error accessing microphone. ';
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                errorMsg += 'Please allow microphone access in browser settings and reload.';
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                errorMsg += 'No microphone found. Please connect a microphone.';
            } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                errorMsg += 'Microphone is being used by another application.';
            } else {
                errorMsg += `Error: ${err.message || 'Unknown error'}. Try using Chrome or Firefox.`;
            }
            statusEl.textContent = errorMsg;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            if (micIndicator) {
                micIndicator.classList.remove('recording');
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusEl.textContent = 'Processing...';
            if (micIndicator) {
                micIndicator.classList.remove('recording');
            }
        }
    }

    async function sendAudio(blob) {
        try {
            const formData = new FormData();
            formData.append('audio', blob, 'recording.webm');

            const response = await fetch('/infer_vosk', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.error) {
                statusEl.textContent = 'Error: ' + data.error;
                transcriptionEl.textContent = '';
            } else if (data.warning) {
                statusEl.textContent = 'Warning: ' + data.warning;
                transcriptionEl.textContent = data.transcription || '(empty - model needs more training)';
                if (data.debug_info) {
                    console.log('Debug info:', data.debug_info);
                }
            } else {
                statusEl.textContent = 'Done';
                transcriptionEl.textContent = data.transcription || '(empty)';
            }

            if (data.transcription !== undefined) {
                const row = document.createElement('tr');
                const noise = (typeof data.noise_db === 'number') ? data.noise_db.toFixed(1) : '-';
                const conf = (typeof data.confidence === 'number' && data.confidence > 0) ? (data.confidence * 100).toFixed(1) + '%' : '-';
                const dur = (typeof data.duration_sec === 'number') ? data.duration_sec.toFixed(2) : '-';
                row.innerHTML = `
                    <td style="padding:0.3rem 0.5rem; border-bottom:1px solid rgba(30,64,175,0.3);">${historyIndex}</td>
                    <td style="padding:0.3rem 0.5rem; border-bottom:1px solid rgba(30,64,175,0.3);">${data.transcription || '(empty)'}</td>
                    <td style="padding:0.3rem 0.5rem; border-bottom:1px solid rgba(30,64,175,0.3);">${noise}</td>
                    <td style="padding:0.3rem 0.5rem; border-bottom:1px solid rgba(30,64,175,0.3);">${conf}</td>
                    <td style="padding:0.3rem 0.5rem; border-bottom:1px solid rgba(30,64,175,0.3);">${dur}</td>
                `;
                historyBody.prepend(row);
                historyIndex += 1;
                while (historyBody.rows.length > 5) {
                    historyBody.deleteRow(historyBody.rows.length - 1);
                }
            }
        } catch (err) {
            console.error(err);
            statusEl.textContent = 'Error sending audio';
        }
    }

    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    // Plot carousel
    const plotSlides = Array.from(document.querySelectorAll('.plot-slide'));
    const prevPlotBtn = document.getElementById('prevPlotBtn');
    const nextPlotBtn = document.getElementById('nextPlotBtn');
    const plotCaption = document.getElementById('plotCaption');
    let plotIndex = 0;

    function updatePlotCarousel() {
        if (!plotSlides.length) return;
        plotSlides.forEach((img, idx) => {
            img.classList.toggle('active', idx === plotIndex);
        });
        if (plotCaption) {
            const caption = plotSlides[plotIndex].dataset.caption || '';
            plotCaption.textContent = caption;
        }
        if (prevPlotBtn && nextPlotBtn) {
            prevPlotBtn.disabled = plotIndex === 0;
            nextPlotBtn.disabled = plotIndex === plotSlides.length - 1;
        }
    }

    if (plotSlides.length) {
        updatePlotCarousel();
        if (prevPlotBtn) {
            prevPlotBtn.addEventListener('click', () => {
                if (plotIndex > 0) {
                    plotIndex -= 1;
                    updatePlotCarousel();
                }
            });
        }
        if (nextPlotBtn) {
            nextPlotBtn.addEventListener('click', () => {
                if (plotIndex < plotSlides.length - 1) {
                    plotIndex += 1;
                    updatePlotCarousel();
                }
            });
        }
    }

    // Diagram carousel
    const diagramSlides = Array.from(document.querySelectorAll('.diagram-slide'));
    const prevDiagramBtn = document.getElementById('prevDiagramBtn');
    const nextDiagramBtn = document.getElementById('nextDiagramBtn');
    const diagramCaption = document.getElementById('diagramCaption');
    let diagramIndex = 0;

    function updateDiagramCarousel() {
        if (!diagramSlides.length) return;
        diagramSlides.forEach((img, idx) => {
            img.classList.toggle('active', idx === diagramIndex);
        });
        if (diagramCaption) {
            const caption = diagramSlides[diagramIndex].dataset.caption || '';
            diagramCaption.textContent = caption;
        }
        if (prevDiagramBtn && nextDiagramBtn) {
            prevDiagramBtn.disabled = diagramIndex === 0;
            nextDiagramBtn.disabled = diagramIndex === diagramSlides.length - 1;
        }
    }

    if (diagramSlides.length) {
        updateDiagramCarousel();
        if (prevDiagramBtn) {
            prevDiagramBtn.addEventListener('click', () => {
                if (diagramIndex > 0) {
                    diagramIndex -= 1;
                    updateDiagramCarousel();
                }
            });
        }
        if (nextDiagramBtn) {
            nextDiagramBtn.addEventListener('click', () => {
                if (diagramIndex < diagramSlides.length - 1) {
                    diagramIndex += 1;
                    updateDiagramCarousel();
                }
            });
        }
    }
</script>
</body>
</html>


